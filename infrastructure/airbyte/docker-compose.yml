version: '3.9'

x-airbyte-db-env: &airbyte-db-env
  POSTGRES_USER: ${AIRBYTE_DB_USER:-airbyte}
  POSTGRES_PASSWORD: ${AIRBYTE_DB_PASSWORD:-password}
  POSTGRES_DB: ${AIRBYTE_DB_NAME:-airbyte}

x-airbyte-logging: &airbyte-logging
  driver: json-file
  options:
    max-size: 50m
    max-file: '5'

services:
  db:
    # Dedicated Postgres backing store. Allocate at least 1 vCPU / 2 GiB RAM for stability.
    image: airbyte/db:1.0.0
    container_name: airbyte-db
    restart: unless-stopped
    environment:
      <<: *airbyte-db-env
    volumes:
      - airbyte-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AIRBYTE_DB_USER:-airbyte}"]
      interval: 10s
      timeout: 5s
      retries: 10
    logging: *airbyte-logging

  temporal:
    # Temporal orchestrates jobs; ensure shared network bandwidth with server/worker nodes. Reserve ~1 vCPU / 1 GiB RAM.
    image: temporalio/auto-setup:1.25.0
    container_name: airbyte-temporal
    restart: unless-stopped
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=${AIRBYTE_DB_USER:-airbyte}
      - POSTGRES_PWD=${AIRBYTE_DB_PASSWORD:-password}
      - POSTGRES_SEEDS=db
    depends_on:
      db:
        condition: service_healthy
    logging: *airbyte-logging

  server:
    # Airbyte API; expect ~512 MiB RAM usage under typical dev loads.
    image: airbyte/airbyte-server:0.50.22
    container_name: airbyte-server
    restart: unless-stopped
    environment:
      - AIRBYTE_ROLE=server
      - DATABASE_USER=${AIRBYTE_DB_USER:-airbyte}
      - DATABASE_PASSWORD=${AIRBYTE_DB_PASSWORD:-password}
      - DATABASE_URL=jdbc:postgresql://db:5432/${AIRBYTE_DB_NAME:-airbyte}
      - DATABASE_MINIMUM_FLYWAY_MIGRATION_VERSION=0.40.24
    # Host port (left) exposes the API; container port (right) must remain 8001.
    ports:
      - "${AIRBYTE_SERVER_PORT:-8001}:8001"
    depends_on:
      db:
        condition: service_healthy
      temporal:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 12
    logging: *airbyte-logging

  webapp:
    # React admin UI served via Nginx; light footprint (<256 MiB RAM).
    image: airbyte/airbyte-webapp:0.50.22
    container_name: airbyte-webapp
    restart: unless-stopped
    environment:
      - AIRBYTE_ROLE=webapp
      - AIRBYTE_API_URL=http://server:8001
    # Host port (left) exposes the UI; container port (right) remains 80 within the container.
    ports:
      - "${AIRBYTE_WEBAPP_PORT:-8000}:80"
    depends_on:
      server:
        condition: service_healthy
    logging: *airbyte-logging

  worker:
    # Execute sync jobs; provision at least 2 vCPU / 4 GiB RAM for parallel destinations.
    image: airbyte/airbyte-worker:0.50.22
    container_name: airbyte-worker
    restart: unless-stopped
    environment:
      - AIRBYTE_ROLE=worker
      - DATABASE_USER=${AIRBYTE_DB_USER:-airbyte}
      - DATABASE_PASSWORD=${AIRBYTE_DB_PASSWORD:-password}
      - DATABASE_URL=jdbc:postgresql://db:5432/${AIRBYTE_DB_NAME:-airbyte}
      - AIRBYTE_API_URL=http://server:8001
      - WORKER_ENVIRONMENT=DOCKER
    depends_on:
      server:
        condition: service_healthy
      temporal:
        condition: service_started
    logging: *airbyte-logging

volumes:
  airbyte-db-data:
