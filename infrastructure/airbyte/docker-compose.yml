x-airbyte-db-env: &airbyte-db-env
  POSTGRES_USER: ${AIRBYTE_DB_USER:-airbyte}
  POSTGRES_PASSWORD: ${AIRBYTE_DB_PASSWORD:-password}
  POSTGRES_DB: ${AIRBYTE_DB_NAME:-airbyte}

x-airbyte-logging: &airbyte-logging
  driver: json-file
  options:
    max-size: 50m
    max-file: '5'

x-airbyte-service-defaults: &airbyte-service-defaults
  env_file:
    - .env
  logging: *airbyte-logging

services:
  db:
    # Dedicated Postgres backing store. Allocate at least 1 vCPU / 2 GiB RAM for stability.
    image: airbyte/db:0.50.22
    container_name: airbyte-db
    restart: unless-stopped
    <<: *airbyte-service-defaults
    environment:
      <<: *airbyte-db-env
    volumes:
      - airbyte-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${AIRBYTE_DB_USER:-airbyte}']
      interval: 10s
      timeout: 5s
      retries: 10

  bootloader:
    # Runs schema migrations before API/worker startup.
    image: airbyte/bootloader:0.50.22
    container_name: airbyte-bootloader
    restart: 'no'
    <<: *airbyte-service-defaults
    environment:
      - AIRBYTE_VERSION=0.50.22
      - DATABASE_USER=${AIRBYTE_DB_USER:-airbyte}
      - DATABASE_PASSWORD=${AIRBYTE_DB_PASSWORD:-password}
      - DATABASE_URL=jdbc:postgresql://db:5432/${AIRBYTE_DB_NAME:-airbyte}
    depends_on:
      db:
        condition: service_healthy

  temporal:
    # Temporal orchestrates jobs; ensure shared network bandwidth with server/worker nodes. Reserve ~1 vCPU / 1 GiB RAM.
    image: temporalio/auto-setup:1.25.0
    container_name: airbyte-temporal
    restart: unless-stopped
    <<: *airbyte-service-defaults
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=${AIRBYTE_DB_USER:-airbyte}
      - POSTGRES_PWD=${AIRBYTE_DB_PASSWORD:-password}
      - POSTGRES_SEEDS=db
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'tctl --address $(hostname -i):7233 cluster health']
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 30s

  server:
    # Airbyte API; expect ~512 MiB RAM usage under typical dev loads.
    image: airbyte/server:0.50.22
    container_name: airbyte-server
    restart: unless-stopped
    <<: *airbyte-service-defaults
    environment:
      - AIRBYTE_ROLE=server
      - AIRBYTE_VERSION=0.50.22
      - MICRONAUT_ENVIRONMENTS=control-plane
      - AIRBYTE_WORKSPACE_ROOT=/tmp/workspace
      - DATABASE_USER=${AIRBYTE_DB_USER:-airbyte}
      - DATABASE_PASSWORD=${AIRBYTE_DB_PASSWORD:-password}
      - DATABASE_URL=jdbc:postgresql://db:5432/${AIRBYTE_DB_NAME:-airbyte}
      - AIRBYTE_FLYWAY_CONFIGS_MINIMUM_MIGRATION_VERSION=0.40.24
      - AIRBYTE_FLYWAY_JOBS_MINIMUM_MIGRATION_VERSION=0.40.24
      - DATABASE_MINIMUM_FLYWAY_MIGRATION_VERSION=0.40.24
      - TRACKING_STRATEGY=logging
      - TEMPORAL_HOST=temporal:7233
      - WEBAPP_URL=http://localhost:${AIRBYTE_WEBAPP_PORT:-18000}
    # Host port (left) exposes the API; container port (right) must remain 8001.
    ports:
      - '${AIRBYTE_SERVER_PORT:-18001}:8001'
    depends_on:
      bootloader:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      temporal:
        condition: service_started
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8001/api/v1/health']
      interval: 10s
      timeout: 5s
      retries: 12

  webapp:
    # React admin UI served via Nginx; light footprint (<256 MiB RAM).
    image: airbyte/webapp:0.50.22
    container_name: airbyte-webapp
    restart: unless-stopped
    <<: *airbyte-service-defaults
    environment:
      - AIRBYTE_ROLE=webapp
      - AIRBYTE_API_URL=http://server:8001
      - TRACKING_STRATEGY=logging
      - INTERNAL_API_HOST=server:8001
      - CONNECTOR_BUILDER_API_HOST=server:8001
      - KEYCLOAK_INTERNAL_HOST=server:8001
    # Host port (left) exposes the UI; container port (right) remains 80 within the container.
    ports:
      - '${AIRBYTE_WEBAPP_PORT:-18000}:80'
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'wget -qO- http://localhost/ >/dev/null || exit 1']
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  worker:
    # Execute sync jobs; provision at least 2 vCPU / 4 GiB RAM for parallel destinations.
    image: airbyte/worker:0.50.22
    container_name: airbyte-worker
    restart: unless-stopped
    <<: *airbyte-service-defaults
    environment:
      - AIRBYTE_ROLE=worker
      - AIRBYTE_VERSION=0.50.22
      - MICRONAUT_ENVIRONMENTS=control-plane
      - TRACKING_STRATEGY=logging
      - SECRET_PERSISTENCE=TESTING_CONFIG_DB_TABLE
      - AIRBYTE_LOCAL_ROOT=/tmp/airbyte_local
      - AIRBYTE_WORKSPACE_ROOT=/tmp/workspace
      - CONFIG_ROOT=/data
      - INTERNAL_API_HOST=server:8001
      - CONFIGS_DATABASE_MINIMUM_FLYWAY_MIGRATION_VERSION=0.40.24
      - JOBS_DATABASE_MINIMUM_FLYWAY_MIGRATION_VERSION=0.40.24
      - LOCAL_ROOT=/tmp/airbyte_local
      - LOCAL_DOCKER_MOUNT=airbyte-local
      - WORKSPACE_ROOT=/tmp/workspace
      - WORKSPACE_DOCKER_MOUNT=airbyte-workspace
      - DATABASE_USER=${AIRBYTE_DB_USER:-airbyte}
      - DATABASE_PASSWORD=${AIRBYTE_DB_PASSWORD:-password}
      - DATABASE_URL=jdbc:postgresql://db:5432/${AIRBYTE_DB_NAME:-airbyte}
      - AIRBYTE_API_URL=http://server:8001
      - TEMPORAL_HOST=temporal:7233
      - WORKER_ENVIRONMENT=DOCKER
    depends_on:
      bootloader:
        condition: service_completed_successfully
      server:
        condition: service_healthy
      temporal:
        condition: service_started
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - airbyte-workspace:/tmp/workspace
      - airbyte-local:/tmp/airbyte_local
    healthcheck:
      test:
        - CMD-SHELL
        - >
          curl -sf http://server:8001/api/v1/health
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 45s

volumes:
  airbyte-db-data:
  airbyte-workspace:
    name: airbyte-workspace
  airbyte-local:
    name: airbyte-local
