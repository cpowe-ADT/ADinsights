name: dbt

on:
  pull_request:
    branches:
      - main
    paths:
      - 'dbt/**'
      - '.github/workflows/dbt.yml'
  push:
    paths:
      - 'dbt/**'
      - '.github/workflows/dbt.yml'
  workflow_dispatch:

jobs:
  run-dbt:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      DBT_PROJECT_DIR: dbt
      DBT_PROFILES_DIR: dbt/.profiles
      DBT_PROFILE: adinsights_duckdb
      DBT_DUCKDB_PATH: dbt/warehouse_ci.duckdb
      DBT_SCHEMA: analytics
      CI_USE_SEEDS: 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt (core + duckdb)
        run: |
          python -m pip install --upgrade pip
          pip install "dbt-core>=1.7,<2.0" "dbt-duckdb>=1.7,<2.0"

      - name: Prepare dbt profile
        run: |
          mkdir -p "$DBT_PROFILES_DIR"
          cp dbt/profiles-ci.yml "$DBT_PROFILES_DIR/profiles.yml"

      - name: Run dbt deps
        run: |
          ./scripts/dbt-wrapper.sh "dbt" "$DBT_PROJECT_DIR" "$DBT_PROFILES_DIR" deps

      - name: Seed CI fixtures
        run: |
          ./scripts/dbt-wrapper.sh "dbt" "$DBT_PROJECT_DIR" "$DBT_PROFILES_DIR" seed --full-refresh

      - name: Build staging + reference
        run: |
          ./scripts/dbt-wrapper.sh "dbt" "$DBT_PROJECT_DIR" "$DBT_PROFILES_DIR" run --select staging_ci

      - name: Test staging + reference
        run: |
          ./scripts/dbt-wrapper.sh "dbt" "$DBT_PROJECT_DIR" "$DBT_PROFILES_DIR" test --select staging_ci
