# Integration Data Contract Matrix (Phase 1)

Purpose: single contract map from source payloads to warehouse/dbt/API surfaces for Meta, Google Ads,
GA4, Search Console, and CSV ingestion.

Owners: Maya (Integrations), Priya (dbt), Sofia (Metrics API). Cross-stream review required from Raj and
Mira because this contract spans infrastructure + dbt + backend + frontend + docs.

Timezone baseline: `America/Jamaica`.

## Meta Ads (Facebook/Instagram via Marketing API)

| Source API object/report                                                                                                                                      | Selected fields                                                                                                                                                                             | Expected type/unit                                                                         | Timezone semantics                                                          | Currency semantics                                                                                   | Primary key grain                                                           | Lookback/latency notes                                                                                                                                                 | Destination raw columns                                                                                  | dbt staging columns                                                                                                                                                                                                                                                             | `/api/metrics/combined/` usage                                                                                 | validated_on | evidence_link |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- | ------------ | ------------- | --- | --------- | ---------- | ----------------------------------------------------------------------------------------------------- |
| Airbyte Facebook Marketing `ad_insights` (`level=ad`, daily) + metadata streams (`ads`, `adsets`, `campaigns`) and direct backend `/api/meta/*` read surfaces | `date_start`, `ad_account_id`/`account_id`, `campaign_id`, `adset_id`, `ad_id`, `region`, `spend`, `impressions`, `reach`, `clicks`, `cpc`, `cpm`, `conversions`, `actions`, `updated_time` | Spend/cost numeric, counts numeric, IDs text, date/date-time strings, `actions` JSON array | Source account timezone; orchestration schedule pinned to `America/Jamaica` | Account currency from source; preserved through staging, aggregated as configured dashboard currency | `(tenant_id, ad_account_id/account_id, campaign_id, adset_id, ad_id, date)` | Incremental sync with lookback replay (yesterday + 3-day lookback); attribution windows can delay final conversions; token revocation/permission drift can stale syncs | `raw.meta_ads_insights`, `raw_meta.ad_insights`, `raw_meta.ads`, `raw_meta.adsets`, `raw_meta.campaigns` | `stg_meta_ads`, `stg_meta_insights`, `stg_meta_ads_metadata`, `stg_meta_adsets`, `stg_meta_campaigns`, snapshots `meta_campaign_snapshot`/`meta_adset_snapshot`/`meta_ad_snapshot`, marts `mart_meta_daily_performance`/`mart_meta_ad_performance`/`mart_meta_campaign_history` | Feeds `fact_performance` -> `vw_dashboard_aggregate_snapshot` plus direct backend APIs `GET /api/meta/accounts | campaigns    | adsets        | ads | insights` | 2026-02-19 | `docs/project/integration-api-validation-checklist.md`, `docs/runbooks/meta-app-review-validation.md` |

## Meta Page Insights + Page Post Insights

| Source API object/report                                            | Selected fields                                                                                                                   | Expected type/unit                                                                                                    | Timezone semantics                                                       | Currency semantics | Primary key grain                                                                     | Lookback/latency notes                                                                                                         | Destination raw columns | dbt staging columns | `/api/metrics/combined/` usage                  | validated_on | evidence_link                                      |
| ------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ | ------------------ | ------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ | ----------------------- | ------------------- | ----------------------------------------------- | ------------ | -------------------------------------------------- |
| Graph API `/{page-id}/insights` and `/{page-post-id}/insights`     | `name`, `period`, `values[].value`, `values[].end_time`, `title`, `description`; post dimension fields from `/{page-id}/posts` | Numeric + object metric values; object metrics are exploded by breakdown key and raw object is preserved in JSON     | Source timestamps are UTC-aware; orchestration remains `America/Jamaica` | N/A                | Page points: `(tenant,page,metric,period,end_time,breakdown)`; Post points: same with `post` | Graph enforces max 90-day since/until windows; most metrics update every ~24h; invalid metrics return `#100` and are registry-invalidated | `integrations_metapage`, `integrations_metapost` | N/A                 | Canonical APIs: `/api/meta/pages/*`, `/api/meta/posts/*`; legacy compatibility: `/api/metrics/meta/pages/*`, `/api/metrics/meta/posts/*` | 2026-02-20   | `docs/runbooks/meta-page-insights-operations.md` |

## Google Ads

| Source API object/report                              | Selected fields                                                                                                                                                                                                       | Expected type/unit                                                   | Timezone semantics                                          | Currency semantics                                                                      | Primary key grain                                                            | Lookback/latency notes                                                                                  | Destination raw columns                                                                      | dbt staging columns                                                         | `/api/metrics/combined/` usage                                                                           | validated_on | evidence_link                                                                                                                                                            |
| ----------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------- | ----------------------------------------------------------- | --------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- | ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Google Ads SDK (`google-ads` v23+) with Airbyte fallback | SDK canonical grains: campaign/day, ad-group-ad/day, geographic/day, keyword/day, search-term/day, asset-group/day, conversion-action/day, change-event incremental, recommendation inventory. Core fields include `date_day`, `customer_id`, entity ids, `cost_micros`, `currency_code`, `impressions`, `clicks`, `conversions`, `conversions_value` and governance metadata (`change_date_time`, `resource_change_operation`). | `cost_micros` integer micros, metrics numeric, IDs text, date/date-time strings | Source account timezone; sync orchestration timezone `America/Jamaica` | Canonical currency from `customer.currency_code`; spend normalized from micros in dbt | SDK primary key per grain, e.g. campaign `(tenant_id, customer_id, campaign_id, date_day)`, search term `(tenant_id, customer_id, campaign_id, ad_group_id, search_term, date_day)`, change events `(tenant_id, customer_id, event_fingerprint)` | SDK incremental lookback replay + parity checks against baseline; auto fallback to Airbyte on repeated failures; optional-query errors persisted in sync metadata when account capability is unavailable | `raw_google_ads_sdk.*` canonical tables (campaign, ad_group_ad, geographic, keyword, search_term, asset_group, conversion_action) with Airbyte raw retained as break-glass fallback | `stg_google_ads_sdk` + new SDK staging models (`stg_google_ads_sdk_campaign_daily`, `stg_google_ads_sdk_keyword_daily`, `stg_google_ads_sdk_search_term_daily`, `stg_google_ads_sdk_asset_group_daily`, `stg_google_ads_sdk_conversion_action_daily`) and compatibility bridge `stg_google_ads` | Feeds `/api/analytics/google-ads/*` reporting surfaces plus `fact_performance` compatibility via `stg_google_ads` | 2026-02-22   | `backend/integrations/google_ads/client.py`, `backend/integrations/tasks.py`, `backend/analytics/google_ads_views.py`, `dbt/models/staging/google_ads_sdk/*` |

## GA4 (Pilot Contract, Phase 2)

| Source API object/report                                                                                                       | Selected fields                                                                                                                                                          | Expected type/unit                                             | Timezone semantics                                                                        | Currency semantics                                                                                    | Primary key grain                                             | Lookback/latency notes                                                                                                        | Destination raw columns | dbt staging columns                  | `/api/metrics/combined/` usage                                                                                   | validated_on       | evidence_link                                                                                                                                              |
| ------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------- | ----------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- | ------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- | ----------------------- | ------------------------------------ | ---------------------------------------------------------------------------------------------------------------- | ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Google Analytics Data API `properties.runReport` + metadata preflight `properties.getMetadata` via Airbyte GA4 source template | Initial set: dimensions `date`, `sessionDefaultChannelGroup`, `country`, `city`, `campaignName`; metrics `sessions`, `engagedSessions`, `conversions`, `purchaseRevenue` | Sessions/conversions integer, revenue numeric, dimensions text | Property timezone authoritative; orchestration/runbook baseline remains `America/Jamaica` | Revenue/currency semantics depend on property/ecommerce settings; currency code carried in raw stream | `(tenant_id, property_id, date, channel/campaign dimensions)` | Sampling/thresholding and retention windows depend on property config; metadata validation required before production rollout | `raw.ga4_reports`       | `stg_ga4_reports` -> `agg_ga4_daily` | Exposed through `/api/analytics/web/ga4/` (Phase 2 pilot endpoint); not yet merged into `/api/metrics/combined/` | 2026-02-06 (pilot) | `infrastructure/airbyte/ga4_source.yaml`, `dbt/models/staging/stg_ga4_reports.sql`, `dbt/models/marts/agg_ga4_daily.sql`, `backend/analytics/web_views.py` |

## Google Search Console (Pilot Contract, Phase 2)

| Source API object/report                                                              | Selected fields                                                                                             | Expected type/unit                                                 | Timezone semantics                                                                                 | Currency semantics        | Primary key grain                              | Lookback/latency notes                                                                                          | Destination raw columns          | dbt staging columns                                | `/api/metrics/combined/` usage                                                                                              | validated_on       | evidence_link                                                                                                                                                                       |
| ------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- | ------------------------- | ---------------------------------------------- | --------------------------------------------------------------------------------------------------------------- | -------------------------------- | -------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- | ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Search Console API `searchanalytics.query` via Airbyte Search Console source template | Dimensions `date`, `country`, `device`, `query`, `page`; metrics `clicks`, `impressions`, `ctr`, `position` | Clicks/impressions integers, ctr/position numeric, dimensions text | Date anchored by Search Console source timezone; operational schedule references `America/Jamaica` | No spend/revenue currency | `(tenant_id, site_url, date, dimension tuple)` | Data is delayed and top-row limited; pagination/batching must be tuned per property prior to production rollout | `raw.search_console_performance` | `stg_search_console` -> `agg_search_console_daily` | Exposed through `/api/analytics/web/search-console/` (Phase 2 pilot endpoint); not yet merged into `/api/metrics/combined/` | 2026-02-06 (pilot) | `infrastructure/airbyte/search_console_source.yaml`, `dbt/models/staging/stg_search_console.sql`, `dbt/models/marts/agg_search_console_daily.sql`, `backend/analytics/web_views.py` |

## CSV Upload Pipeline

| Source API object/report                                                                  | Selected fields                                                                                                                                                                                                                                                 | Expected type/unit                                                                                           | Timezone semantics                                                                                            | Currency semantics                                                       | Primary key grain                                      | Lookback/latency notes                          | Destination raw columns                                                  | dbt staging columns            | `/api/metrics/combined/` usage                                                                               | validated_on | evidence_link                                                                                         |
| ----------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ | ------------------------------------------------------ | ----------------------------------------------- | ------------------------------------------------------------------------ | ------------------------------ | ------------------------------------------------------------------------------------------------------------ | ------------ | ----------------------------------------------------------------------------------------------------- |
| Upload API multipart files (`campaign_csv`, optional `parish_csv`, optional `budget_csv`) | Campaign required: `date`, `campaign_id`, `campaign_name`, `platform`, `spend`, `impressions`, `clicks`, `conversions`; Parish required: `parish`, `spend`, `impressions`, `clicks`, `conversions`; Budget required: `month`, `campaign_name`, `planned_budget` | Date/month string normalized to ISO, numeric coercion for spend/metrics, optional revenue/roas/pacing fields | Upload records treated as day/month values; operational schedule/reporting timezone remains `America/Jamaica` | Currency optional per row; fallback/default handled during payload build | Upload snapshot grain by campaign/date and parish/date | Immediate validation at upload; no API lookback | Stored in `TenantMetricsSnapshot` source `upload` (no Airbyte raw table) | Not modeled in dbt for Phase 1 | Directly serves `source=upload` on `/api/metrics/combined/` and can backfill campaign/parish/budget sections | 2026-02-06   | `docs/runbooks/csv-uploads.md`, `backend/analytics/uploads.py`, `frontend/src/lib/uploadedMetrics.ts` |

## Open Validation Actions

1. Meta authenticated portal validation remains a manual external step because Meta developer docs are crawler-restricted.
2. GA4 and Search Console are now Phase 2 pilot contracts with raw/staging/mart + API exposure; production rollout still requires real OAuth credentials and external connector validation.
3. Contract drift gate is enforced by:
   - `python3 infrastructure/airbyte/scripts/check_data_contracts.py`
   - `pytest -q <path>/test_data_contract_checks.py` (repository test path currently missing; tracked as follow-up to restore executable contract-test target)
